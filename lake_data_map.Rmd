---
title: "Status of Lake Data for Temperature Modeling"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r firstMap}
library(leaflet)
library(feather)

df <- feather(file.path("8_viz", "inout", "lakes_summary.feather"))
df <- data.frame(df)

col_types <- c("darkblue","dodgerblue","green4","gold1","orange","brown","red")

#df$n_profile_years_size <- df$n_profile_years
#df$n_profile_years_size <- 7*df$n_profile_years_size/(max(df$n_profile_years_size,na.rm = TRUE))

#df$n_profile_years_size[is.na(df$n_profile_years_size)] <- 2

df$popup <- paste0("<table>",
                   "<tr><td>Lake Name:</td><td>",
                   df$GNIS_Name,'</td></tr>',
                   "<tr><td>Site ID:</td><td>",
                   df$site_id,'</td></tr>',
                   "<tr><td># Observations:</td><td>",
                   df$n_obs,'</td></tr>',
                   "<tr><td># Profiles:</td><td>",
                   df$n_profiles,'</td></tr>',
                   "<tr><td>Years w/ >5 profiles:</td><td>",
                   df$n_years_6profs,'</td></tr>',
                   "<tr><td>Crosswalked to:</td><td>",
                   df$Lake_Source,'</td></tr>',
                   '</table>')

col_types <- c("darkblue","dodgerblue","green4","gold1","orange","brown","red")
  
legend_vals <- unique(as.numeric(quantile(c(0,df$n_obs), probs=c(0,0.1,0.5,0.9,.99,1), na.rm=TRUE)))

pal = leaflet::colorBin(palette = 'viridis', c(0,df$n_obs), bins = legend_vals, na.color = 'red', reverse = TRUE)

leaflet::leaflet(height = "800px", width = "1000px") %>%
    leaflet::addProviderTiles("CartoDB.Positron") %>%
    leaflet::setView(lng = -92.5, lat = 44.5, zoom=5) %>%
    leaflet::addCircleMarkers(data= dplyr::filter(df, hypsography & kw_file & meteo),
                              lat=~latitude, lng=~longitude, 
                              group = "TOHA lake",
                              popup= ~popup,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
  leaflet::addCircleMarkers(data= dplyr::filter(df, n_profiles > 50 & !hypsography),
                              lat=~latitude, lng=~longitude, 
                              group = "Lots of data, no hypso",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
    leaflet::addCircleMarkers(data= dplyr::filter(df, zmax & kw & !meteo & n_profiles > 10),
                              lat=~latitude, lng=~longitude, 
                              group = "PGDL, but no meteo",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= dplyr::filter(df, kw_file, !kw),
                              lat=~latitude, lng=~longitude, 
                              group = "Kw_file, no kw",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= dplyr::filter(df, hypsography),
                              lat=~latitude, lng=~longitude, 
                              group = "hypsography",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= dplyr::filter(df, zmax & kw & meteo & n_profiles > 10),
                              lat=~latitude, lng=~longitude, 
                              group = "PGDL lake",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
    leaflet::addCircleMarkers(data= dplyr::filter(df, zmax & kw & meteo),
                              lat=~latitude, lng=~longitude, 
                              group = "GLM lake",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= dplyr::filter(df, zmax & kw & !meteo),
                              lat=~latitude, lng=~longitude, 
                              group = "GLM lake, but no meteo",
                              popup= ~popup ,
                     fillColor = ~pal(n_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
  leaflet::addLegend(data = df, pal = pal,
                     position = 'bottomleft',
                     values=~n_obs,
                     labFormat = leaflet::labelFormat(digits = 0),
                     title = "Number of observations") %>%
  addLayersControl(
    baseGroups = c("TOHA lake","PGDL lake","GLM lake","Kw_file, no kw","hypsography", "Lots of data, no hypso", "PGDL, but no meteo", "GLM lake, but no meteo"),
    #overlayGroups = c("observed","hypsography", "zmax", "kw","kw_file","meteo"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup(c("No observations","Observed but no zmax",">100 profiles & no hypsometry"))


```
