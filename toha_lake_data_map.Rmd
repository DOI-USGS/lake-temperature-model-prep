---
title: "Status of Lake Data for TOHA Modeling"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r filterData, echo=FALSE}
library(sf)
library(dplyr)

mn_lake_summary_sf <- readRDS(file.path("8_viz", "inout", "summary_toha_sf.rds"))
mn_lake_summary_df <- mn_lake_summary_sf
mn_lake_summary_df$geometry <- NULL

mn_lake_summary_df$popup <- paste0("<table>",
                   "<tr><td>Lake Name:</td><td>",
                   mn_lake_summary_df$GNIS_Name,'</td></tr>',
                   "<tr><td>Site ID:</td><td>",
                   mn_lake_summary_df$site_id,'</td></tr>',
                   "<tr><td># Temp Observations:</td><td>",
                   mn_lake_summary_df$n_temp_obs,'</td></tr>',
                   "<tr><td># Profiles:</td><td>",
                   mn_lake_summary_df$n_profiles,'</td></tr>',
                   "<tr><td>Years w/ >5 profiles:</td><td>",
                   mn_lake_summary_df$n_years_6profs,'</td></tr>',
                   "<tr><td>Crosswalked to:</td><td>",
                   mn_lake_summary_df$Lake_Source,'</td></tr>',
                   "<tr><td># Walleye Yrs:</td><td>",
                   mn_lake_summary_df$n_walleye_yrs,'</td></tr>',
                   '</table>')

all_criteria_walleye <- mn_lake_summary_df %>%
    filter(n_walleye_yrs >= 5, # already doing this in CSV
           n_profiles >= 10,
           has_time_varying_kw,
           zmax,
           hypsography)

mn_lakes_w_zmax_hypso <- mn_lake_summary_df %>%
  filter(zmax,
         hypsography)

mn_lakes_w_hypso_prof <- mn_lake_summary_df %>%
  filter(hypsography) %>%
  filter(n_profiles >= 10)

lakes_with_timevaryingkw <- mn_lakes_w_zmax_hypso %>%
  filter(has_time_varying_kw)

lakes_model_toha <- lakes_with_timevaryingkw %>%
  filter(n_walleye_yrs >= 5)

lakes_gucci <- lakes_with_timevaryingkw %>%
  filter(n_profiles >= 50)

lakes_timex <- lakes_with_timevaryingkw %>%
  filter(n_profiles >= 10, n_profiles < 50)

lakes_gucci_walleye <- lakes_gucci %>%
  filter(n_walleye_yrs >= 5)

lakes_timex_walleye <- lakes_timex %>%
  filter(n_walleye_yrs >= 5)
```

```{r firstMap}
library(leaflet)

col_types <- c("darkblue","dodgerblue","green4","gold1","orange","brown","red")
  
legend_vals <- unique(as.numeric(quantile(c(0,mn_lake_summary_df$n_temp_obs), probs=c(0,0.1,0.5,0.9,.99,1), na.rm=TRUE)))

pal = leaflet::colorBin(palette = 'viridis', c(0, mn_lake_summary_df$n_temp_obs), bins = legend_vals, na.color = 'red', reverse = TRUE)

groups <- c(
  "Zmax & hypso",
  "Zmax, hypso, & time-varying kw",
  "TOHA model: zmax, hypso, time-varying kw, & walleye",
  "PGDL gucci",
  "PGDL light",
  "PGDL gucci w/ walleye",
  "PGDL light w/ walleye"
)

leaflet::leaflet(height = "800px", width = "1000px") %>%
    leaflet::addProviderTiles("CartoDB.Positron") %>%
    leaflet::setView(lng = -92.5, lat = 44.5, zoom=5) %>%
    leaflet::addCircleMarkers(data= mn_lakes_w_zmax_hypso,
                              lat=~latitude, lng=~longitude, 
                              group = groups[1],
                              popup= ~popup,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
  leaflet::addCircleMarkers(data= lakes_with_timevaryingkw,
                              lat=~latitude, lng=~longitude, 
                              group = groups[2],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
    leaflet::addCircleMarkers(data= lakes_model_toha,
                              lat=~latitude, lng=~longitude, 
                              group = groups[3],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= lakes_gucci,
                              lat=~latitude, lng=~longitude, 
                              group = groups[4],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= lakes_timex,
                              lat=~latitude, lng=~longitude, 
                              group = groups[5],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
      leaflet::addCircleMarkers(data= lakes_gucci_walleye,
                              lat=~latitude, lng=~longitude, 
                              group = groups[6],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
    leaflet::addCircleMarkers(data= lakes_timex_walleye,
                              lat=~latitude, lng=~longitude, 
                              group = groups[7],
                              popup= ~popup ,
                     fillColor = ~pal(n_temp_obs),
                     fillOpacity = 0.8,
                     radius = ~4,
                     stroke=FALSE) %>%
  leaflet::addLegend(data = mn_lake_summary_df, pal = pal,
                     position = 'bottomleft',
                     values=~n_temp_obs,
                     labFormat = leaflet::labelFormat(digits = 0),
                     title = "Number of observations") %>%
  addLayersControl(
    baseGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  hideGroup(groups[-1])


```
